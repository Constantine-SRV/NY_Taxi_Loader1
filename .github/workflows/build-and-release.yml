name: Build and Release

on:
  workflow_dispatch:
    inputs:
      command:
        description: 'Build command'
        required: true
        default: 'build-all'
        type: choice
        options:
          - build-all

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Compile Java sources
        run: |
          echo "=== Compiling Java sources ==="
          mkdir -p build/classes
          
          # Получаем все JAR файлы из lib
          CLASSPATH=$(find lib -name "*.jar" | tr '\n' ':')
          echo "Classpath: $CLASSPATH"
          
          # Компилируем все Java файлы
          find src -name "*.java" > sources.txt
          echo "Found $(wc -l < sources.txt) Java source files"
          
          javac -d build/classes -cp "$CLASSPATH" @sources.txt
          
          echo "✓ Compilation completed!"

      - name: Create Fat JAR with proper META-INF merging
        run: |
          echo "=== Creating Fat JAR with all dependencies ==="
          
          mkdir -p build/jar-temp
          cd build/jar-temp
          
          # Копируем скомпилированные классы
          echo "Copying compiled classes..."
          cp -r ../classes/* .
          
          # Создаем директорию для мержинга META-INF/services
          mkdir -p META-INF/services
          
          # Извлекаем каждый JAR и мержим META-INF/services
          echo "Extracting and merging JARs..."
          for jar in ../../lib/*.jar; do
            jarname=$(basename "$jar")
            echo "Processing: $jarname"
            
            # Создаем временную директорию для этого JAR
            tempdir=$(mktemp -d)
            cd "$tempdir"
            jar xf "$jar" 2>/dev/null || true
            
            # Мержим META-INF/services файлы
            if [ -d "META-INF/services" ]; then
              for service in META-INF/services/*; do
                if [ -f "$service" ]; then
                  servicename=$(basename "$service")
                  echo "  Merging service: $servicename"
                  cat "$service" >> "$OLDPWD/META-INF/services/$servicename"
                fi
              done
            fi
            
            # Удаляем META-INF перед копированием классов
            rm -rf META-INF
            
            # Копируем все классы (кроме уже обработанных META-INF)
            cp -r . "$OLDPWD/" 2>/dev/null || true
            
            cd "$OLDPWD"
            rm -rf "$tempdir"
          done
          
          # Удаляем дубликаты в META-INF/services файлах
          echo "Removing duplicates from service files..."
          for service in META-INF/services/*; do
            if [ -f "$service" ]; then
              sort -u "$service" -o "$service"
            fi
          done
          
          # Создаем MANIFEST
          echo "Creating MANIFEST..."
          cat > MANIFEST.MF << EOF
Manifest-Version: 1.0
Main-Class: Main
Created-By: GitHub Actions

EOF
          
          # Создаем итоговый JAR
          echo "Building final JAR..."
          jar cmf MANIFEST.MF ../OBLoader1.jar *
          
          cd ../..
          
          # Показываем размер итогового JAR
          ls -lh build/OBLoader1.jar
          echo "✓ Fat JAR created successfully!"
          
          # Показываем содержимое META-INF/services
          echo ""
          echo "=== META-INF/services contents ==="
          unzip -l build/OBLoader1.jar | grep "META-INF/services"

      - name: Copy JAR to root
        run: |
          cp build/OBLoader1.jar ./OBLoader1.jar
          echo "Final JAR size: $(du -h OBLoader1.jar | cut -f1)"

      - name: List root directory
        run: ls -la ./

      - name: List JAR contents
        run: |
          echo "=== JAR file structure ==="
          unzip -l OBLoader1.jar | head -50
          echo "..."
          echo "Total entries: $(unzip -l OBLoader1.jar | tail -1)"

      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Authenticate GitHub CLI
        run: echo ${{ secrets.GH_TOKEN }} | gh auth login --with-token

      - name: Delete existing release if exists
        run: |
          if gh release view latest_release; then
            gh release delete latest_release -y
          fi

      - name: Create Release
        run: |
          gh release create latest_release ./OBLoader1.jar -t "Release latest_release"
