name: Build and Release

on:
  workflow_dispatch:
    inputs:
      command:
        description: 'Build command'
        required: true
        default: 'build-all'
        type: choice
        options:
          - build-all

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Compile Java sources
        run: |
          echo "=== Compiling Java sources ==="
          mkdir -p build/classes
          
          CLASSPATH=$(find lib -name "*.jar" | tr '\n' ':')
          
          find src -name "*.java" > sources.txt
          javac -d build/classes -cp "$CLASSPATH" @sources.txt
          
          echo "Compilation completed"

      - name: Extract all JAR libraries
        run: |
          echo "=== Extracting all JAR libraries ==="
          mkdir -p build/extracted
          cd build/extracted
          
          for jar in ../../lib/*.jar; do
            echo "Extracting: $(basename $jar)"
            jar xf "$jar"
          done
          
          echo "All JARs extracted"
          du -sh .

      - name: Remove signature files
        run: |
          echo "=== Removing signature files ==="
          cd build/extracted/META-INF
          rm -f *.SF *.RSA *.DSA MSFTSIG.SF MSFTSIG.RSA
          rm -f MANIFEST.MF
          echo "Signature files removed"

      - name: Merge META-INF services
        run: |
          echo "=== Merging META-INF/services files ==="
          cd build/extracted
          
          if [ -d "META-INF/services" ]; then
            for service in META-INF/services/*; do
              if [ -f "$service" ]; then
                echo "Processing: $(basename $service)"
                sort -u "$service" -o "$service"
              fi
            done
          fi

      - name: Copy compiled classes
        run: |
          echo "=== Copying compiled classes ==="
          cp -r build/classes/* build/extracted/
          echo "Classes copied"

      - name: Create final JAR
        run: |
          echo "=== Creating final JAR ==="
          cd build/extracted
          
          cat > MANIFEST.MF << 'EOF'
          Manifest-Version: 1.0
          Main-Class: Main
          
          EOF
          
          jar cmf MANIFEST.MF ../OBLoader1.jar .
          
          cd ..
          ls -lh OBLoader1.jar
          echo "JAR size: $(du -h OBLoader1.jar | cut -f1)"

      - name: Copy JAR to root
        run: |
          cp build/OBLoader1.jar ./OBLoader1.jar

      - name: List root directory
        run: ls -la ./

      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Authenticate GitHub CLI
        run: echo ${{ secrets.GH_TOKEN }} | gh auth login --with-token

      - name: Delete existing release if exists
        run: |
          if gh release view latest_release; then
            gh release delete latest_release -y
          fi

      - name: Create Release
        run: |
          gh release create latest_release ./OBLoader1.jar -t "Release latest_release"
