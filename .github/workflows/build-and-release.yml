name: Build and Release

on:
  workflow_dispatch:
    inputs:
      command:
        description: 'Build command'
        required: true
        default: 'build-all'
        type: choice
        options:
          - build-all

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Compile Java sources
        run: |
          echo "=== Compiling Java sources ==="
          mkdir -p build/classes
          
          CLASSPATH=$(find lib -name "*.jar" | tr '\n' ':')
          echo "Classpath: $CLASSPATH"
          
          find src -name "*.java" > sources.txt
          echo "Found $(wc -l < sources.txt) Java source files"
          
          javac -d build/classes -cp "$CLASSPATH" @sources.txt
          
          echo "Compilation completed"

      - name: Create Fat JAR with proper META-INF merging
        run: |
          echo "=== Creating Fat JAR with all dependencies ==="
          
          mkdir -p build/jar-temp
          cd build/jar-temp
          
          echo "Copying compiled classes..."
          cp -r ../classes/* .
          
          mkdir -p META-INF/services
          
          echo "Extracting and merging JARs..."
          for jar in ../../lib/*.jar; do
            jarname=$(basename "$jar")
            echo "Processing: $jarname"
            
            tempdir=$(mktemp -d)
            cd "$tempdir"
            jar xf "$jar" 2>/dev/null || true
            
            if [ -d "META-INF/services" ]; then
              for service in META-INF/services/*; do
                if [ -f "$service" ]; then
                  servicename=$(basename "$service")
                  echo "  Merging service: $servicename"
                  cat "$service" >> "$OLDPWD/META-INF/services/$servicename"
                fi
              done
            fi
            
            rm -rf META-INF
            
            cp -r . "$OLDPWD/" 2>/dev/null || true
            
            cd "$OLDPWD"
            rm -rf "$tempdir"
          done
          
          echo "Removing duplicates from service files..."
          for service in META-INF/services/*; do
            if [ -f "$service" ]; then
              sort -u "$service" -o "$service"
            fi
          done
          
          echo "Creating MANIFEST..."
          cat > MANIFEST.MF << 'EOF'
          Manifest-Version: 1.0
          Main-Class: Main
          Created-By: GitHub Actions
          
          EOF
          
          echo "Building final JAR..."
          jar cmf MANIFEST.MF ../OBLoader1.jar .
          
          cd ../..
          
          ls -lh build/OBLoader1.jar
          echo "Fat JAR created successfully"

      - name: Copy JAR to root
        run: |
          cp build/OBLoader1.jar ./OBLoader1.jar
          echo "Final JAR size: $(du -h OBLoader1.jar | cut -f1)"

      - name: List root directory
        run: ls -la ./

      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Authenticate GitHub CLI
        run: echo ${{ secrets.GH_TOKEN }} | gh auth login --with-token

      - name: Delete existing release if exists
        run: |
          if gh release view latest_release; then
            gh release delete latest_release -y
          fi

      - name: Create Release
        run: |
          gh release create latest_release ./OBLoader1.jar -t "Release latest_release"
