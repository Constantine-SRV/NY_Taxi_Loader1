name: Build and Release

on:
  workflow_dispatch:
    inputs:
      command:
        description: 'Build command'
        required: true
        default: 'build-all'
        type: choice
        options:
          - build-all

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Compile Java sources
        run: |
          echo "Compiling Java sources..."
          mkdir -p build/classes
          
          # Получаем все JAR файлы из lib
          CLASSPATH=$(find lib -name "*.jar" | tr '\n' ':')
          
          # Компилируем все Java файлы
          find src -name "*.java" > sources.txt
          javac -d build/classes -cp "$CLASSPATH" @sources.txt
          
          echo "Compilation completed!"

      - name: Create Fat JAR
        run: |
          echo "Creating Fat JAR with all dependencies..."
          cd build/classes
          
          # Извлекаем все классы из зависимостей
          for jar in ../../lib/*.jar; do
            echo "Extracting $jar..."
            jar xf "$jar"
          done
          
          # Удаляем META-INF из зависимостей (кроме services)
          find META-INF -type f ! -name 'services' -delete 2>/dev/null || true
          
          # Создаем MANIFEST с main классом
          echo "Manifest-Version: 1.0" > MANIFEST.MF
          echo "Main-Class: Main" >> MANIFEST.MF
          echo "" >> MANIFEST.MF
          
          # Создаем JAR
          jar cmf MANIFEST.MF ../OBLoader1.jar *
          
          cd ../..
          mv build/OBLoader1.jar ./OBLoader1.jar
          
          echo "Fat JAR created successfully!"

      - name: List root directory
        run: ls -la ./

      - name: List JAR file
        run: ls -la ./OBLoader1.jar

      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Authenticate GitHub CLI
        run: echo ${{ secrets.GH_TOKEN }} | gh auth login --with-token

      - name: Delete existing release if exists
        run: |
          if gh release view latest_release; then
            gh release delete latest_release -y
          fi

      - name: Create Release
        run: |
          gh release create latest_release ./OBLoader1.jar -t "Release latest_release"
