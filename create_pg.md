# table +part
```sql
-- =========================================================
-- БЛОК 1. Выполнить под суперпользователем (например, postgres)
-- =========================================================

-- 1. Создаём базу nytaxidb
CREATE DATABASE nytaxidb
    WITH TEMPLATE = template0
         ENCODING = 'UTF8'
         LC_COLLATE = 'C'
         LC_CTYPE   = 'C';

-- 2. Даём пользователю bbuser полные права на эту БД
GRANT ALL PRIVILEGES ON DATABASE nytaxidb TO bbuser;

-- 3. Переключаемся в созданную базу (psql-метакоманда)
\c nytaxidb

-- 4. Даём bbuser права на схему public (иначе он не сможет создавать таблицы)
GRANT USAGE, CREATE ON SCHEMA public TO bbuser;

-- (опционально, но удобно: сделать bbuser владельцем базы)
ALTER DATABASE nytaxidb OWNER TO bbuser;



-- =========================================================
-- БЛОК 2. Выполнить под пользователем bbuser в базе nytaxidb
--       (в psql: \c nytaxidb bbuser)
-- =========================================================

-- Родительская таблица с партиционированием по pickup_datetime
CREATE TABLE taxi_trips (
    trip_id               integer GENERATED BY DEFAULT AS IDENTITY,
    pickup_datetime       timestamp NOT NULL,
    vendor_id             smallint  NOT NULL,
    dropoff_datetime      timestamp NOT NULL,
    passenger_count       smallint  NOT NULL DEFAULT 0,
    trip_distance         numeric(11,2) NOT NULL DEFAULT 0,
    rate_code_id          smallint  NOT NULL DEFAULT 1,
    store_and_fwd_flag    char(1)   DEFAULT 'N',
    pu_location_id        smallint  NOT NULL,
    do_location_id        smallint  NOT NULL,
    payment_type          smallint  NOT NULL,
    fare_amount           numeric(12,2) NOT NULL DEFAULT 0,
    extra                 numeric(10,2) NOT NULL DEFAULT 0,
    mta_tax               numeric(10,2) NOT NULL DEFAULT 0,
    tip_amount            numeric(11,2) NOT NULL DEFAULT 0,
    tolls_amount          numeric(10,2) NOT NULL DEFAULT 0,
    improvement_surcharge numeric(10,2) NOT NULL DEFAULT 0,
    total_amount          numeric(10,2) NOT NULL DEFAULT 0,
    congestion_surcharge  numeric(10,2) NOT NULL DEFAULT 0,
    PRIMARY KEY (pickup_datetime, trip_id)
) PARTITION BY RANGE (pickup_datetime);

COMMENT ON TABLE taxi_trips IS 'NYC Taxi trip data';



-- =========================================================
-- БЛОК 3. Партиции: до 2010, по годам 2010–2025, и после 2025
-- =========================================================

-- Всё, что раньше 2010-01-01
CREATE TABLE taxi_trips_before2010
    PARTITION OF taxi_trips
    FOR VALUES FROM (MINVALUE) TO ('2010-01-01');

-- 2010
CREATE TABLE taxi_trips_2010
    PARTITION OF taxi_trips
    FOR VALUES FROM ('2010-01-01') TO ('2011-01-01');

-- 2011
CREATE TABLE taxi_trips_2011
    PARTITION OF taxi_trips
    FOR VALUES FROM ('2011-01-01') TO ('2012-01-01');

-- 2012
CREATE TABLE taxi_trips_2012
    PARTITION OF taxi_trips
    FOR VALUES FROM ('2012-01-01') TO ('2013-01-01');

-- 2013
CREATE TABLE taxi_trips_2013
    PARTITION OF taxi_trips
    FOR VALUES FROM ('2013-01-01') TO ('2014-01-01');

-- 2014
CREATE TABLE taxi_trips_2014
    PARTITION OF taxi_trips
    FOR VALUES FROM ('2014-01-01') TO ('2015-01-01');

-- 2015
CREATE TABLE taxi_trips_2015
    PARTITION OF taxi_trips
    FOR VALUES FROM ('2015-01-01') TO ('2016-01-01');

-- 2016
CREATE TABLE taxi_trips_2016
    PARTITION OF taxi_trips
    FOR VALUES FROM ('2016-01-01') TO ('2017-01-01');

-- 2017
CREATE TABLE taxi_trips_2017
    PARTITION OF taxi_trips
    FOR VALUES FROM ('2017-01-01') TO ('2018-01-01');

-- 2018
CREATE TABLE taxi_trips_2018
    PARTITION OF taxi_trips
    FOR VALUES FROM ('2018-01-01') TO ('2019-01-01');

-- 2019
CREATE TABLE taxi_trips_2019
    PARTITION OF taxi_trips
    FOR VALUES FROM ('2019-01-01') TO ('2020-01-01');

-- 2020
CREATE TABLE taxi_trips_2020
    PARTITION OF taxi_trips
    FOR VALUES FROM ('2020-01-01') TO ('2021-01-01');

-- 2021
CREATE TABLE taxi_trips_2021
    PARTITION OF taxi_trips
    FOR VALUES FROM ('2021-01-01') TO ('2022-01-01');

-- 2022
CREATE TABLE taxi_trips_2022
    PARTITION OF taxi_trips
    FOR VALUES FROM ('2022-01-01') TO ('2023-01-01');

-- 2023
CREATE TABLE taxi_trips_2023
    PARTITION OF taxi_trips
    FOR VALUES FROM ('2023-01-01') TO ('2024-01-01');

-- 2024
CREATE TABLE taxi_trips_2024
    PARTITION OF taxi_trips
    FOR VALUES FROM ('2024-01-01') TO ('2025-01-01');

-- 2025
CREATE TABLE taxi_trips_2025
    PARTITION OF taxi_trips
    FOR VALUES FROM ('2025-01-01') TO ('2026-01-01');

-- Всё, что >= 2026-01-01
CREATE TABLE taxi_trips_after2025
    PARTITION OF taxi_trips
    FOR VALUES FROM ('2026-01-01') TO (MAXVALUE);

```
# indexes
```sql

-- =========================================================
-- БЛОК 4. Индексы по _id полям
-- (создаём на родителе — PG сам создаст локальные индексы на партициях)
-- =========================================================

CREATE INDEX idx_taxi_vendor_id
    ON taxi_trips (vendor_id);

CREATE INDEX idx_taxi_rate_code_id
    ON taxi_trips (rate_code_id);

CREATE INDEX idx_taxi_pu_location_id
    ON taxi_trips (pu_location_id);

CREATE INDEX idx_taxi_do_location_id
    ON taxi_trips (do_location_id);

CREATE INDEX idx_taxi_payment_type
    ON taxi_trips (payment_type);

-- (опционально) индекс для диапазонных запросов по времени
-- CREATE INDEX idx_taxi_pickup_brin
--     ON taxi_trips USING brin (pickup_datetime);

```
